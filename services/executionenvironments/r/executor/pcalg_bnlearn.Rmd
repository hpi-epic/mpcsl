---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(bnlearn)
library(pcalg)
library(igraph)
library(dplyr)
#install.packages("graphNEL")
#install.packages('pcalg', dependencies = TRUE)
```

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
#BiocManager::install()

if (!requireNamespace("RBGL", quietly = TRUE))
  biocLite("RBGL")

if (!requireNamespace("Rgraphviz", quietly = TRUE))
  biocLite("Rgraphviz")

#BiocManager::install(c("RBGL", "Rgraphviz"))
if (!requireNamespace("pcalg", quietly = TRUE))
  install.packages('pcalg', dependencies = TRUE)
```


```{r}
discrete_node_limit <- 4
```


```{r}
input_graph_file <- "/Users/lukas/git/mpci/services/executionenvironments/r/executor/test_data/ground_truth.gml"
graph <- read.graph(input_graph_file, format="gml")
graph_nel <- igraph.to.graphNEL(graph)

dataset_file <- "/Users/lukas/git/mpci/services/executionenvironments/r/executor/test_data/dataset.csv"
df <- read.csv(dataset_file, header=TRUE, check.names=FALSE)

subset_size <- Inf
verbose <- FALSE
```

```{r}
#Format dataframe

# convert datatypes numeric (continuous) -> if exceed discrete node_limit else factor (discrete)
casted_df <- df %>% 
  dplyr::mutate_all(
    funs(
      if(length(unique(.)) < discrete_node_limit)
        as.factor(.)
      else as.numeric(as.numeric(.))
      )
    ) %>% 
  as.data.frame()

# increase column names by one because R starts counting at 1
colnames(casted_df) <- as.character(as.numeric(colnames(casted_df)) + 1)
```

```{r}
micgCallback <- function(x, y, S, suffStat) {
  
  data_types <- sapply(suffStat$dm, class) # list of data types per columns

  #Determine test
  all_variabes <- as.character(append(list(x, y), S))
  found_types <- list()
  for (var in all_variabes) {
    found_types <- append(data_types[var], found_types)
  }
  distinct_types <- sort(unlist(unique(found_types), use.names=FALSE))
  types_string <- paste(distinct_types, collapse = '_')
  ci_test <- switch(
    types_string,
    "numeric" = "cor", # only continuous values
    "factor" = "x2", # only discrete values
    "factor_numeric" = "mi-cg" # mixed values
  )
  
  # Execute test
  htest <- ci.test(
    as.character(x),
    as.character(y),
    as.character(S),
    suffStat$dm,
    ci_test
  )
  
  #return p-value of test
  htest$"p.value"
}
```


```{r}
stuffStat <- list(dm = casted_df)
pc.bntest.fit = pc(
  suffStat=stuffStat,
  verbose=verbose,
  indepTest=micgCallback, m.max=subset_size,
  p=ncol(casted_df),
  alpha=0.05,
  numCores=1,
  skel.method="stable.fast"
)

pc.fit <- pc(
  suffStat = list(C = cor(casted_df), n = nrow(casted_df)),
  indepTest = gaussCItest,
  p=ncol(casted_df),
  alpha = 0.05,
  verbose = verbose
)
par(mfrow=c(1,3))
plot(graph_nel, main = "Ground truth")
plot(pc.fit, main = "pcalg native")
plot(pc.bntest.fit , main = "pcalg with bnlearn test")


#graph <- result@'graph'
#igraphDAG <- igraph.from.graphNEL(graph)
#write_graph(igraphDAG, tmpGraphFile, "gml")

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

